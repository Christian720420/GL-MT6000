name: Build OpenWrt Targets

permissions:
  contents: write
  actions: read

on:
  push:
    branches:
      - main
    paths:
      - "*.config"
      - "files/**"
      - ".github/workflows/build-openwrt.yaml"
  workflow_dispatch:
    inputs:
      target:
        description: "Which target to build"
        required: false
        default: all
        type: choice
        options:
          - all
          - gl-mt6000
          - wr3000
      remote_ref:
        description: "Override upstream ref (optional)"
        required: false
        default: ""
  schedule:
    - cron: "38 1 * * *"

concurrency:
  group: openwrt-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  BUILDER_REPO: ${{ github.repository }}
  DL_CACHE_VERSION: v1
  ARTIFACT_RETENTION_DAYS: 10
  GH_TOKEN: ${{ github.token }}

jobs:
  build:
    name: Build ${{ matrix.pretty }}
    runs-on: ${{ fromJson(matrix.runner) }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: gl-mt6000
            pretty: Flint 2 (GL-MT6000)
            config_file: mt6000.config
            remote_repository: pesa1234/openwrt
            remote_ref: auto-next
            release_prefix: gl-mt6000
            artifact_prefix: gl-mt6000
            runner: '["self-hosted","linux","x64","selfrunner"]'
          - id: wr3000
            pretty: Cudy WR3000-v1
            config_file: wr3000.config
            remote_repository: openwrt/openwrt
            remote_ref: main
            release_prefix: wr3000
            artifact_prefix: wr3000
            runner: '["self-hosted","linux","x64","selfrunner"]'

    steps:
      - name: Evaluate target filter
        id: filter
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && \
             [ -n "${{ github.event.inputs.target }}" ] && \
             [ "${{ github.event.inputs.target }}" != "all" ] && \
             [ "${{ github.event.inputs.target }}" != "${{ matrix.id }}" ]; then
            echo "skip=true" >> "$GITHUB_OUTPUT"
            echo "Skipping target ${{ matrix.id }}"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Checkout builder repository
        if: steps.filter.outputs.skip == 'false'
        uses: actions/checkout@v4
        with:
          path: builder

      - name: Install build dependencies (apt)
        if: steps.filter.outputs.skip == 'false'
        run: |
          if command -v apt >/dev/null 2>&1; then
            sudo apt update
            sudo apt install -y build-essential clang flex bison g++ gawk gettext libncurses-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget llvm
          else
            echo "Skipping apt install on non-apt runner"
          fi

      - name: Fetch upstream OpenWrt source
        if: steps.filter.outputs.skip == 'false'
        id: upstream
        run: |
          set -euo pipefail
          REF="${{ matrix.remote_ref }}"
          if [ "$REF" = "auto-next" ]; then
            REF=$(git ls-remote https://github.com/${{ matrix.remote_repository }}.git "refs/heads/next-*" \
              | grep -vi 'test' \
              | awk '{print $2}' \
              | sed 's|refs/heads/||' \
              | sort -V \
              | tail -n1)
          fi
          if [ -n "${{ github.event.inputs.remote_ref }}" ]; then
            REF="${{ github.event.inputs.remote_ref }}"
          fi
          if [ -z "$REF" ]; then
            echo "Unable to determine upstream ref" >&2
            exit 1
          fi
          git clone --filter=blob:none --single-branch --branch "$REF" https://github.com/${{ matrix.remote_repository }}.git openwrt
          cd openwrt
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Update and install feeds
        if: steps.filter.outputs.skip == 'false'
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          ./scripts/feeds install -a

      - name: Restore downloads cache
        if: steps.filter.outputs.skip == 'false'
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: openwrt-dl-${{ matrix.id }}-${{ env.DL_CACHE_VERSION }}-${{ hashFiles(format('builder/{0}', matrix.config_file)) }}
          restore-keys: |
            openwrt-dl-${{ matrix.id }}-${{ env.DL_CACHE_VERSION }}-

      - name: Prepare configuration and overlay
        if: steps.filter.outputs.skip == 'false'
        run: |
          cd openwrt
          mkdir -p files
          cp -a ../builder/files/. ./files/
          if [ -f ./files/usr/bin/upgrade_custom_openwrt ]; then
            sed -i "s|XXXXXX/XXXXXX|${{ github.repository }}|" ./files/usr/bin/upgrade_custom_openwrt || true
            chmod 755 ./files/usr/bin/upgrade_custom_openwrt
          fi
          cp ../builder/${{ matrix.config_file }} .config
          make defconfig

      - name: Download sources
        if: steps.filter.outputs.skip == 'false'
        run: |
          cd openwrt
          make download -j$(nproc) || make download -j1 V=s

      - name: Build firmware
        if: steps.filter.outputs.skip == 'false'
        run: |
          cd openwrt
          make -j$(nproc) || {
            echo "Falling back to single-thread build"
            make -j1 V=s
          }

      - name: Collect firmware artifacts
        if: steps.filter.outputs.skip == 'false'
        run: |
          cd openwrt
          ART_DIR="artifacts/${{ matrix.id }}"
          mkdir -p "$ART_DIR"
          cp .config "$ART_DIR/full.config"
          find bin -type f \( -name 'openwrt-*-sysupgrade.bin' -o -name 'openwrt-*-factory.bin' -o -name 'config.buildinfo' -o -name 'sha256sums' \) -exec cp {} "$ART_DIR" \; || true
          if ls "$ART_DIR"/openwrt-*.bin >/dev/null 2>&1; then
            (cd "$ART_DIR" && sha256sum openwrt-*.bin > sha256sums.txt)
          fi

      - name: Upload firmware artifact
        if: steps.filter.outputs.skip == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_prefix }}-firmware
          path: openwrt/artifacts/${{ matrix.id }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Prepare release notes
        if: steps.filter.outputs.skip == 'false'
        id: meta
        run: |
          tag="${{ matrix.release_prefix }}-$(date +%Y%m%d-%H%M)"
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
          echo "release_name=${{ matrix.pretty }} firmware ($tag)" >> "$GITHUB_OUTPUT"
          cat <<'EOF' > release-notes-${{ matrix.id }}.md
          ### Target
          - Name: ${{ matrix.pretty }}
          - Config: `${{ matrix.config_file }}`

          ### Upstream
          - Repository: https://github.com/${{ matrix.remote_repository }}
          - Ref: ${{ steps.upstream.outputs.ref }}
          - Commit: ${{ steps.upstream.outputs.commit }}

          ### Notes
          - Artifacts contain sysupgrade images, buildinfo, and `.config`
          - Built from https://github.com/${{ github.repository }}
          EOF

      - name: Publish release
        if: steps.filter.outputs.skip == 'false' && (github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: ${{ steps.meta.outputs.release_tag }}
          name: ${{ steps.meta.outputs.release_name }}
          bodyFile: release-notes-${{ matrix.id }}.md
          artifacts: openwrt/artifacts/${{ matrix.id }}/*
          replacesArtifacts: true
          makeLatest: false
