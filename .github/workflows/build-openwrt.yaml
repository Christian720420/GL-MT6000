name: Build OpenWrt WR3000

permissions:
  contents: write
  actions: read

on:
  push:
    branches:
      - main
    paths:
      - "*.config"
      - "files/**"
      - ".github/workflows/build-openwrt.yaml"
  workflow_dispatch:
    inputs:
      remote_ref:
        description: "Override upstream ref (optional)"
        required: false
        default: ""
  schedule:
    - cron: "38 1 * * *"

concurrency:
  group: openwrt-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  TARGET_ID: wr3000
  TARGET_NAME: "Cudy WR3000-v1"
  CONFIG_FILE: wr3000.config
  REMOTE_REPOSITORY: openwrt/openwrt
  DEFAULT_REMOTE_REF: main
  RELEASE_PREFIX: wr3000
  ARTIFACT_PREFIX: wr3000
  DL_CACHE_VERSION: v1
  ARTIFACT_RETENTION_DAYS: 10
  GH_TOKEN: ${{ github.token }}

jobs:
  build:
    name: Build Cudy WR3000-v1
    runs-on:
      - self-hosted
      - linux
      - x64
      - debian

    steps:
      - name: Checkout builder repository
        uses: actions/checkout@v4
        with:
          path: builder

      - name: Install build dependencies (apt)
        run: |
          if command -v apt >/dev/null 2>&1; then
            sudo apt update
            sudo apt install -y build-essential clang flex bison g++ gawk gettext libncurses-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget llvm
          else
            echo "Skipping apt install on non-apt runner"
          fi

      - name: Fetch upstream OpenWrt source
        id: upstream
        run: |
          set -euo pipefail
          REF="${{ github.event.inputs.remote_ref }}"
          if [ -z "$REF" ]; then
            REF="${{ env.DEFAULT_REMOTE_REF }}"
          fi
          if [ -z "$REF" ]; then
            echo "Unable to determine upstream ref" >&2
            exit 1
          fi
          git clone --filter=blob:none --single-branch --branch "$REF" https://github.com/${{ env.REMOTE_REPOSITORY }}.git openwrt
          cd openwrt
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Update and install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          ./scripts/feeds install -a

      - name: Restore downloads cache
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: openwrt-dl-${{ env.TARGET_ID }}-${{ env.DL_CACHE_VERSION }}-${{ hashFiles(format('builder/{0}', env.CONFIG_FILE)) }}
          restore-keys: |
            openwrt-dl-${{ env.TARGET_ID }}-${{ env.DL_CACHE_VERSION }}-

      - name: Prepare configuration and overlay
        run: |
          cd openwrt
          mkdir -p files
          cp -a ../builder/files/. ./files/
          if [ -f ./files/usr/bin/upgrade_custom_openwrt ]; then
            sed -i "s|XXXXXX/XXXXXX|${{ github.repository }}|" ./files/usr/bin/upgrade_custom_openwrt || true
            chmod 755 ./files/usr/bin/upgrade_custom_openwrt
          fi
          cp ../builder/${{ env.CONFIG_FILE }} .config
          make defconfig

      - name: Download sources
        run: |
          cd openwrt
          make download -j$(nproc) || make download -j1 V=s

      - name: Build firmware
        run: |
          cd openwrt
          make -j$(nproc) || {
            echo "Falling back to single-thread build"
            make -j1 V=s
          }

      - name: Collect firmware artifacts
        run: |
          cd openwrt
          ART_DIR="artifacts/${{ env.TARGET_ID }}"
          mkdir -p "$ART_DIR"
          cp .config "$ART_DIR/full.config"
          find bin -type f \( -name 'openwrt-*-sysupgrade.bin' -o -name 'openwrt-*-factory.bin' -o -name 'config.buildinfo' -o -name 'sha256sums' \) -exec cp {} "$ART_DIR" \; || true
          if ls "$ART_DIR"/openwrt-*.bin >/dev/null 2>&1; then
            (cd "$ART_DIR" && sha256sum openwrt-*.bin > sha256sums.txt)
          fi

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_PREFIX }}-firmware
          path: openwrt/artifacts/${{ env.TARGET_ID }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Prepare release notes
        id: meta
        run: |
          tag="${{ env.RELEASE_PREFIX }}-$(date +%Y%m%d-%H%M)"
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
          echo "release_name=${{ env.TARGET_NAME }} firmware ($tag)" >> "$GITHUB_OUTPUT"
          cat <<'EOF' > release-notes-${{ env.TARGET_ID }}.md
          ### Target
          - Name: ${{ env.TARGET_NAME }}
          - Config: `${{ env.CONFIG_FILE }}`

          ### Upstream
          - Repository: https://github.com/${{ env.REMOTE_REPOSITORY }}
          - Ref: ${{ steps.upstream.outputs.ref }}
          - Commit: ${{ steps.upstream.outputs.commit }}

          ### Notes
          - Artifacts contain sysupgrade images, buildinfo, and `.config`
          - Built from https://github.com/${{ github.repository }}
          EOF

      - name: Publish release
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: ${{ steps.meta.outputs.release_tag }}
          name: ${{ steps.meta.outputs.release_name }}
          bodyFile: release-notes-${{ env.TARGET_ID }}.md
          artifacts: openwrt/artifacts/${{ env.TARGET_ID }}/*
          replacesArtifacts: true
          makeLatest: false
