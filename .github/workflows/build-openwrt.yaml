# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# OpenWrt Firmware Builder - Cudy WR3000-v1
# Advanced CI/CD Pipeline with Full Feature Set
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
name: Build OpenWrt Firmware

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# WORKFLOW TRIGGERS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
on:
  # Trigger on push to main branch (filtered by paths)
  push:
    branches: [main]
    paths:
      - "*.config"
      - "files/**"
      - ".github/workflows/build-openwrt.yaml"

  # Trigger on pull requests (for testing)
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]
    paths:
      - "*.config"
      - "files/**"

  # Manual trigger with full options
  workflow_dispatch:
    inputs:
      remote_ref:
        description: "Upstream branch/tag/commit"
        type: string
        default: "main"
        required: false
      clean_build:
        description: "Force clean build (ignore all caches)"
        type: boolean
        default: false
        required: false
      verbose:
        description: "Enable verbose build output (V=s)"
        type: boolean
        default: false
        required: false
      single_thread:
        description: "Force single-threaded build (debug)"
        type: boolean
        default: false
        required: false
      create_release:
        description: "Create GitHub release"
        type: boolean
        default: true
        required: false
      release_type:
        description: "Release type"
        type: choice
        options:
          - "latest"
          - "prerelease"
          - "draft"
        default: "latest"
        required: false
      extra_packages:
        description: "Extra packages to include (space-separated)"
        type: string
        default: ""
        required: false
      kernel_version:
        description: "Override kernel version (leave empty for default)"
        type: string
        default: ""
        required: false

  # Scheduled builds
  schedule:
    - cron: "38 1 * * *"      # Daily at 01:38 UTC
    - cron: "0 12 * * 0"      # Weekly on Sunday at noon UTC

  # Triggered by other workflows
  workflow_call:
    inputs:
      remote_ref:
        description: "Upstream ref to build"
        type: string
        default: "main"
      config_file:
        description: "Config file to use"
        type: string
        default: "wr3000.config"
    outputs:
      artifact_name:
        description: "Name of uploaded artifact"
        value: ${{ jobs.build.outputs.artifact_name }}
      firmware_version:
        description: "Built firmware version"
        value: ${{ jobs.prepare.outputs.tag }}
    secrets:
      DEPLOY_KEY:
        description: "Optional deploy key for private repos"
        required: false

  # Trigger on release events (for rebuild)
  release:
    types: [published, edited]

  # Repository dispatch for external triggers
  repository_dispatch:
    types: [build-firmware, upstream-update]

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# CONCURRENCY CONTROL
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
concurrency:
  group: openwrt-${{ github.workflow }}-${{ github.ref_name }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# PERMISSIONS (Principle of Least Privilege)
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
permissions:
  contents: write          # For creating releases
  actions: read            # For reading workflow artifacts
  packages: write          # For container registry (future)
  pull-requests: write     # For PR comments
  issues: write            # For issue comments
  checks: write            # For status checks
  statuses: write          # For commit statuses
  deployments: write       # For deployments

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# DEFAULT SETTINGS FOR ALL JOBS
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
defaults:
  run:
    shell: bash

# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
# GLOBAL CONFIGURATION
# ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
env:
  # Target configuration
  DEVICE_NAME: "Cudy WR3000-v1"
  DEVICE_ID: "cudy_wr3000-v1"
  CONFIG_FILE: ${{ inputs.config_file || 'wr3000.config' }}
  UPSTREAM_REPO: "openwrt/openwrt"
  UPSTREAM_REF: "main"

  # Cache configuration
  CACHE_VERSION: "v3"
  CACHE_SAVE_ALWAYS: true

  # Build configuration
  BUILD_TIMEOUT: 480
  DOWNLOAD_TIMEOUT: 30
  FEEDS_TIMEOUT: 15
  JOBS_MULTIPLIER: 1

  # Artifact configuration
  ARTIFACT_RETENTION: 14
  RELEASE_PREFIX: "wr3000"
  COMPRESSION_LEVEL: 6

  # ccache configuration
  CCACHE_MAXSIZE: "10G"
  CCACHE_COMPRESS: "true"
  CCACHE_COMPRESSLEVEL: "6"
  CCACHE_SLOPPINESS: "file_macro,time_macros,include_file_mtime"

  # Git configuration
  GIT_CLONE_DEPTH: 1
  GIT_HTTP_POST_BUFFER: "524288000"
  GIT_HTTP_LOW_SPEED_LIMIT: "1000"
  GIT_HTTP_LOW_SPEED_TIME: "300"

  # Retry configuration
  MAX_RETRIES: 5
  RETRY_DELAY: 10

  # Feature flags
  ENABLE_CCACHE: true
  ENABLE_BUILD_LOG: true
  ENABLE_KERNEL_DEBUG: false
  ENABLE_PACKAGE_DEBUG: false

  # Timezone
  TZ: "UTC"

jobs:
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 1: PREPARATION - Resolve refs, validate inputs, generate metadata
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  prepare:
    name: üîç Prepare
    runs-on: self-hosted
    timeout-minutes: 10
    
    # Job outputs for downstream jobs
    outputs:
      ref: ${{ steps.resolve.outputs.ref }}
      commit: ${{ steps.resolve.outputs.commit }}
      short: ${{ steps.resolve.outputs.short }}
      tag: ${{ steps.meta.outputs.tag }}
      date: ${{ steps.meta.outputs.date }}
      timestamp: ${{ steps.meta.outputs.timestamp }}
      cache_key: ${{ steps.meta.outputs.cache_key }}
      should_release: ${{ steps.check.outputs.should_release }}
      is_prerelease: ${{ steps.check.outputs.is_prerelease }}
      is_draft: ${{ steps.check.outputs.is_draft }}
      runner_arch: ${{ steps.system.outputs.arch }}
      runner_os: ${{ steps.system.outputs.os }}

    # Environment variables for this job
    env:
      BUILD_REF: ${{ inputs.remote_ref || 'main' }}

    steps:
      - name: "üñ•Ô∏è System information"
        id: system
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  System Information                                          "
          echo "‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£"
          echo "‚ïë  Runner: ${{ runner.name }}"
          echo "‚ïë  OS: ${{ runner.os }}"
          echo "‚ïë  Arch: ${{ runner.arch }}"
          echo "‚ïë  Event: ${{ github.event_name }}"
          echo "‚ïë  Ref: ${{ github.ref }}"
          echo "‚ïë  SHA: ${{ github.sha }}"
          echo "‚ïë  Actor: ${{ github.actor }}"
          echo "‚ïë  Workflow: ${{ github.workflow }}"
          echo "‚ïë  Run ID: ${{ github.run_id }}"
          echo "‚ïë  Run Number: ${{ github.run_number }}"
          echo "‚ïë  Run Attempt: ${{ github.run_attempt }}"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          
          echo "arch=$(uname -m)" >> "$GITHUB_OUTPUT"
          echo "os=$(uname -s)" >> "$GITHUB_OUTPUT"

      - name: "üìã Generate build metadata"
        id: meta
        run: |
          DATE=$(date -u '+%Y-%m-%d')
          TIMESTAMP=$(date -u '+%Y%m%d-%H%M%S')
          TAG="${{ env.RELEASE_PREFIX }}-$(date +%Y%m%d-%H%M)"
          CACHE_KEY="${{ env.CACHE_VERSION }}-$(date +%Y%m%d)"
          
          echo "date=$DATE" >> "$GITHUB_OUTPUT"
          echo "timestamp=$TIMESTAMP" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "cache_key=$CACHE_KEY" >> "$GITHUB_OUTPUT"
          
          # GitHub Actions step summary
          echo "## üìã Build Metadata" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Date | $DATE |" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | $TAG |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Key | $CACHE_KEY |" >> $GITHUB_STEP_SUMMARY

      - name: "üîé Resolve upstream reference"
        id: resolve
        run: |
          REF="${{ inputs.remote_ref || env.UPSTREAM_REF }}"
          
          echo "üîé Resolving: $REF"
          
          # Try as branch first
          COMMIT=$(git ls-remote "https://github.com/${{ env.UPSTREAM_REPO }}.git" "refs/heads/$REF" | cut -f1)
          
          # Try as tag
          [ -z "$COMMIT" ] && COMMIT=$(git ls-remote "https://github.com/${{ env.UPSTREAM_REPO }}.git" "refs/tags/$REF" | cut -f1)
          
          # Try as commit SHA (if length >= 7)
          if [ -z "$COMMIT" ] && [ ${#REF} -ge 7 ]; then
            COMMIT="$REF"
          fi
          
          if [ -z "$COMMIT" ]; then
            echo "::error::Cannot resolve ref: $REF"
            exit 1
          fi
          
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "commit=$COMMIT" >> "$GITHUB_OUTPUT"
          echo "short=${COMMIT:0:7}" >> "$GITHUB_OUTPUT"
          
          echo "‚úÖ Resolved: $REF ‚Üí ${COMMIT:0:7}"
          
          # Add to step summary
          echo "## üîé Upstream Reference" >> $GITHUB_STEP_SUMMARY
          echo "- **Ref:** \`$REF\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`$COMMIT\`" >> $GITHUB_STEP_SUMMARY

      - name: "‚úÖ Check release conditions"
        id: check
        run: |
          SHOULD_RELEASE="false"
          IS_PRERELEASE="false"
          IS_DRAFT="false"
          
          # Determine if we should create a release
          if [ "${{ github.event_name }}" = "schedule" ]; then
            SHOULD_RELEASE="true"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            if [ "${{ inputs.create_release }}" = "true" ]; then
              SHOULD_RELEASE="true"
            fi
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            SHOULD_RELEASE="true"
          fi
          
          # Check release type
          if [ "${{ inputs.release_type }}" = "prerelease" ]; then
            IS_PRERELEASE="true"
          elif [ "${{ inputs.release_type }}" = "draft" ]; then
            IS_DRAFT="true"
          fi
          
          echo "should_release=$SHOULD_RELEASE" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$IS_PRERELEASE" >> "$GITHUB_OUTPUT"
          echo "is_draft=$IS_DRAFT" >> "$GITHUB_OUTPUT"
          
          echo "üì¶ Release: $SHOULD_RELEASE (prerelease: $IS_PRERELEASE, draft: $IS_DRAFT)"

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 2: BUILD - Main compilation job with full options
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  build:
    name: üî® Build
    runs-on: self-hosted
    needs: prepare
    timeout-minutes: 480
    
    # Continue on error for specific scenarios
    continue-on-error: ${{ github.event_name == 'pull_request' }}
    
    # Job outputs
    outputs:
      firmware_name: ${{ steps.collect.outputs.firmware_name }}
      firmware_size: ${{ steps.collect.outputs.firmware_size }}
      firmware_sha256: ${{ steps.collect.outputs.firmware_sha256 }}
      artifact_name: ${{ steps.collect.outputs.artifact_name }}
      build_duration: ${{ steps.timing.outputs.duration }}
      cache_hit: ${{ steps.cache_status.outputs.hit }}

    # Job-level environment
    env:
      UPSTREAM_REF: ${{ needs.prepare.outputs.ref }}
      UPSTREAM_COMMIT: ${{ needs.prepare.outputs.commit }}
      BUILD_DATE: ${{ needs.prepare.outputs.date }}
      CACHE_KEY: ${{ needs.prepare.outputs.cache_key }}
      CCACHE_DIR: ~/.ccache
      CCACHE_MAXSIZE: "10G"
      FORCE_UNSAFE_CONFIGURE: 1
      TERM: xterm-256color

    steps:
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # TIMING & SETUP
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "‚è±Ô∏è Start build timer"
        id: timer_start
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: "üìã Build info"
        run: |
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  OpenWrt Build: ${{ env.DEVICE_NAME }}"
          echo "‚ïë  Date: ${{ needs.prepare.outputs.date }}"
          echo "‚ïë  Upstream: ${{ env.UPSTREAM_REPO }}@${{ needs.prepare.outputs.short }}"
          echo "‚ïë  Event: ${{ github.event_name }}"
          echo "‚ïë  Clean Build: ${{ inputs.clean_build || 'false' }}"
          echo "‚ïë  Verbose: ${{ inputs.verbose || 'false' }}"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"

      - name: "üßπ Clean workspace"
        run: |
          # Aggressive cleanup
          rm -rf openwrt builder 2>/dev/null || true
          find . -maxdepth 1 -name "*.log" -delete 2>/dev/null || true
          
          # Show disk space
          echo "üíæ Disk space:"
          df -h . | grep -v tmpfs
          
          # Show memory
          echo "üíª Memory:"
          free -h

      - name: "üì• Checkout config"
        uses: actions/checkout@v4
        with:
          path: builder
          fetch-depth: 0
          submodules: recursive
          lfs: false

      - name: "üîß Verify dependencies"
        id: deps
        run: |
          REQUIRED="git gcc g++ make gawk wget unzip python3 rsync flex bison ccache"
          MISSING=""
          
          for cmd in $REQUIRED; do
            if ! command -v $cmd >/dev/null 2>&1; then
              MISSING="$MISSING $cmd"
            fi
          done
          
          if [ -n "$MISSING" ]; then
            echo "üì¶ Installing missing packages:$MISSING"
            sudo apt-get update -qq
            sudo apt-get install -y -qq \
              build-essential clang flex bison g++ gawk \
              gettext libncurses-dev libssl-dev python3-setuptools \
              rsync swig unzip zlib1g-dev file wget llvm \
              ccache libelf-dev python3-distutils python3-pyelftools \
              qemu-utils device-tree-compiler
          fi
          
          # Configure ccache
          if command -v ccache >/dev/null 2>&1; then
            ccache --max-size=${{ env.CCACHE_MAXSIZE }}
            ccache --set-config=compression=true
            ccache --set-config=compression_level=6
            ccache -z  # Zero stats
            echo "installed=true" >> "$GITHUB_OUTPUT"
          else
            echo "installed=false" >> "$GITHUB_OUTPUT"
          fi

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # CLONE SOURCE
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üì¶ Clone OpenWrt"
        id: clone
        run: |
          echo "üîó Cloning ${{ env.UPSTREAM_REPO }} @ ${{ needs.prepare.outputs.ref }}"
          
          # Configure git for large repos
          git config --global http.postBuffer ${{ env.GIT_HTTP_POST_BUFFER }}
          git config --global http.lowSpeedLimit ${{ env.GIT_HTTP_LOW_SPEED_LIMIT }}
          git config --global http.lowSpeedTime ${{ env.GIT_HTTP_LOW_SPEED_TIME }}
          git config --global core.compression 0
          git config --global advice.detachedHead false
          
          # Clone with retry
          for i in 1 2 3; do
            if git clone --depth=${{ env.GIT_CLONE_DEPTH }} --single-branch \
              --branch "${{ needs.prepare.outputs.ref }}" \
              "https://github.com/${{ env.UPSTREAM_REPO }}.git" openwrt; then
              break
            fi
            echo "‚ö†Ô∏è Clone attempt $i failed, retrying..."
            rm -rf openwrt
            sleep $((i * 5))
          done
          
          cd openwrt
          echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "‚úÖ $(git log -1 --format='%h %s')"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # CACHING (with save-always option)
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üíæ Restore ccache"
        id: cache_ccache
        if: ${{ !inputs.clean_build }}
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ env.DEVICE_ID }}-${{ needs.prepare.outputs.cache_key }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ env.DEVICE_ID }}-${{ needs.prepare.outputs.cache_key }}-
            ccache-${{ env.DEVICE_ID }}-
            ccache-

      - name: "üíæ Restore downloads"
        id: cache_dl
        if: ${{ !inputs.clean_build }}
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: dl-${{ env.DEVICE_ID }}-${{ needs.prepare.outputs.cache_key }}-${{ hashFiles('builder/*.config') }}
          restore-keys: |
            dl-${{ env.DEVICE_ID }}-${{ needs.prepare.outputs.cache_key }}-
            dl-${{ env.DEVICE_ID }}-
            dl-

      - name: "üíæ Restore toolchain"
        id: cache_toolchain
        if: ${{ !inputs.clean_build }}
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/staging_dir/host
            openwrt/build_dir/toolchain-*
            openwrt/build_dir/host
          key: toolchain-${{ env.DEVICE_ID }}-${{ hashFiles('builder/*.config') }}-${{ needs.prepare.outputs.short }}
          restore-keys: |
            toolchain-${{ env.DEVICE_ID }}-${{ hashFiles('builder/*.config') }}-
            toolchain-${{ env.DEVICE_ID }}-

      - name: "üíæ Restore feeds"
        id: cache_feeds
        if: ${{ !inputs.clean_build }}
        uses: actions/cache@v4
        with:
          path: |
            openwrt/feeds
            openwrt/package/feeds
          key: feeds-${{ env.DEVICE_ID }}-${{ needs.prepare.outputs.cache_key }}-${{ github.sha }}
          restore-keys: |
            feeds-${{ env.DEVICE_ID }}-${{ needs.prepare.outputs.cache_key }}-
            feeds-${{ env.DEVICE_ID }}-
            feeds-

      - name: "üìä Cache status"
        id: cache_status
        run: |
          HIT="false"
          if [ "${{ steps.cache_toolchain.outputs.cache-hit }}" = "true" ]; then
            HIT="true"
            echo "‚úÖ Toolchain cache hit"
          fi
          if [ "${{ steps.cache_dl.outputs.cache-hit }}" = "true" ]; then
            echo "‚úÖ Downloads cache hit"
          fi
          if [ "${{ steps.cache_ccache.outputs.cache-hit }}" = "true" ]; then
            echo "‚úÖ ccache cache hit"
          fi
          if [ "${{ steps.cache_feeds.outputs.cache-hit }}" = "true" ]; then
            echo "‚úÖ Feeds cache hit"
          fi
          echo "hit=$HIT" >> "$GITHUB_OUTPUT"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # FEEDS
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üì° Update feeds"
        id: feeds
        timeout-minutes: ${{ fromJSON(env.FEEDS_TIMEOUT) }}
        run: |
          cd openwrt
          
          echo "üì° Updating feeds..."
          RETRY_COUNT=0
          MAX_RETRIES=${{ env.MAX_RETRIES }}
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Attempt $RETRY_COUNT/$MAX_RETRIES..."
            
            if timeout 600 ./scripts/feeds update -a 2>&1; then
              echo "‚úÖ Feeds updated"
              break
            fi
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              DELAY=$((RETRY_COUNT * ${{ env.RETRY_DELAY }}))
              echo "‚ö†Ô∏è Failed, retrying in ${DELAY}s..."
              sleep $DELAY
              
              # Clean up locks
              find feeds -name '*.lock' -delete 2>/dev/null || true
              find feeds -name 'index.lock' -delete 2>/dev/null || true
            else
              echo "::error::Feeds update failed after $MAX_RETRIES attempts"
              exit 1
            fi
          done
          
          # Install feeds (twice for dependencies)
          ./scripts/feeds install -a
          ./scripts/feeds install -a
          echo "‚úÖ Feeds installed"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # CONFIGURATION
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "‚öôÔ∏è Apply configuration"
        id: config
        run: |
          cd openwrt
          
          # Copy overlay files
          mkdir -p files
          if [ -d ../builder/files ]; then
            cp -a ../builder/files/. ./files/
            echo "‚úÖ Overlay files copied"
          fi
          
          # Patch upgrade script
          if [ -f files/usr/bin/upgrade_custom_openwrt ]; then
            sed -i "s|XXXXXX/XXXXXX|${{ github.repository }}|g" files/usr/bin/upgrade_custom_openwrt
            chmod 755 files/usr/bin/upgrade_custom_openwrt
          fi
          
          # Apply base config
          cp ../builder/${{ env.CONFIG_FILE }} .config
          
          # Enable ccache
          if [ "${{ env.ENABLE_CCACHE }}" = "true" ]; then
            echo "CONFIG_CCACHE=y" >> .config
          fi
          
          # Enable build logging
          if [ "${{ env.ENABLE_BUILD_LOG }}" = "true" ]; then
            echo "CONFIG_BUILD_LOG=y" >> .config
          fi
          
          # Enable devel for ccache
          echo "CONFIG_DEVEL=y" >> .config
          
          # Add extra packages if specified
          if [ -n "${{ inputs.extra_packages }}" ]; then
            echo "üì¶ Adding extra packages: ${{ inputs.extra_packages }}"
            for pkg in ${{ inputs.extra_packages }}; do
              echo "CONFIG_PACKAGE_${pkg}=y" >> .config
            done
          fi
          
          # Override kernel version if specified
          if [ -n "${{ inputs.kernel_version }}" ]; then
            echo "üêß Overriding kernel: ${{ inputs.kernel_version }}"
            sed -i "s/CONFIG_LINUX_.*/CONFIG_LINUX_${{ inputs.kernel_version }}=y/" .config
          fi
          
          # Expand config
          make defconfig
          
          # Show key config options
          echo "üìã Key configuration:"
          grep -E "^CONFIG_(TARGET_|PACKAGE_luci|KERNEL_)" .config | head -20 || true
          
          echo "‚úÖ Configuration applied"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # DOWNLOAD
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "‚¨áÔ∏è Download packages"
        id: download
        timeout-minutes: ${{ fromJSON(env.DOWNLOAD_TIMEOUT) }}
        run: |
          cd openwrt
          
          CORES=$(nproc)
          JOBS=$((CORES * 2))
          
          echo "‚¨áÔ∏è Downloading with $JOBS parallel jobs..."
          
          # Try parallel first, fallback to sequential
          if ! make download -j$JOBS IGNORE_ERRORS=1; then
            echo "‚ö†Ô∏è Parallel download had issues, retrying..."
            make download -j$CORES || make download -j1 V=s
          fi
          
          # Verify downloads
          MISSING=$(find dl -size 0 -type f 2>/dev/null | wc -l)
          if [ "$MISSING" -gt 0 ]; then
            echo "‚ö†Ô∏è Found $MISSING empty downloads, cleaning up..."
            find dl -size 0 -type f -delete
            make download -j4 V=s
          fi
          
          echo "‚úÖ Downloads: $(du -sh dl/ | cut -f1)"
          echo "size=$(du -sh dl/ | cut -f1)" >> "$GITHUB_OUTPUT"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # BUILD
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üî® Compile firmware"
        id: compile
        run: |
          cd openwrt
          
          # Determine job count
          CORES=$(nproc)
          if [ "${{ inputs.single_thread }}" = "true" ]; then
            JOBS=1
            echo "‚ö†Ô∏è Single-threaded build requested"
          else
            JOBS=$((CORES + 1))
          fi
          
          # Determine verbosity
          if [ "${{ inputs.verbose }}" = "true" ]; then
            VERBOSE="V=s"
          else
            VERBOSE="V=w"
          fi
          
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  Starting Build                                              "
          echo "‚ïë  Jobs: $JOBS | Verbose: $VERBOSE"
          echo "‚ïë  Cores: $CORES | Memory: $(free -h | awk '/Mem:/ {print $2}')"
          echo "‚ïë  Disk: $(df -h . | awk 'NR==2 {print $4}') available"
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          
          # Build with intelligent fallback
          BUILD_SUCCESS="false"
          
          # Attempt 1: Full parallel
          echo "üî® Build attempt 1: -j$JOBS $VERBOSE"
          if make -j$JOBS $VERBOSE 2>&1 | tee build.log; then
            BUILD_SUCCESS="true"
          else
            echo "::warning::Parallel build failed"
            
            # Free space
            rm -rf build_dir/target-*/root-* tmp/ 2>/dev/null || true
            
            # Attempt 2: Half parallel
            HALF_JOBS=$((JOBS / 2))
            [ $HALF_JOBS -lt 1 ] && HALF_JOBS=1
            echo "üî® Build attempt 2: -j$HALF_JOBS $VERBOSE"
            
            if make -j$HALF_JOBS $VERBOSE 2>&1 | tee -a build.log; then
              BUILD_SUCCESS="true"
            else
              echo "::warning::Reduced parallel build failed"
              
              # Attempt 3: Single thread with full verbosity
              echo "üî® Build attempt 3: -j1 V=s"
              if make -j1 V=s 2>&1 | tee -a build.log; then
                BUILD_SUCCESS="true"
              fi
            fi
          fi
          
          if [ "$BUILD_SUCCESS" = "false" ]; then
            echo "::error::Build failed after all attempts"
            
            # Show last errors
            echo "=== Last 50 lines of build log ==="
            tail -50 build.log || true
            
            # Show any error logs
            echo "=== Error logs ==="
            find logs -name "*.txt" -exec tail -20 {} \; 2>/dev/null || true
            
            exit 1
          fi
          
          echo ""
          echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
          echo "‚ïë  ‚úÖ BUILD SUCCESSFUL                                         "
          echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
          
          # Show ccache stats
          if command -v ccache >/dev/null 2>&1; then
            echo ""
            echo "üìä ccache statistics:"
            ccache -s | head -10
          fi
          
          echo "success=true" >> "$GITHUB_OUTPUT"

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # ARTIFACTS
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "üì¶ Collect artifacts"
        id: collect
        run: |
          cd openwrt
          
          OUTDIR="output"
          mkdir -p "$OUTDIR"
          
          # Collect firmware files
          find bin/targets -type f \( \
            -name '*-sysupgrade.bin' -o \
            -name '*-factory.bin' -o \
            -name '*-initramfs-kernel.bin' -o \
            -name '*.img.gz' -o \
            -name '*.manifest' -o \
            -name 'sha256sums' -o \
            -name 'config.buildinfo' -o \
            -name 'feeds.buildinfo' -o \
            -name 'version.buildinfo' \
          \) -exec cp {} "$OUTDIR/" \;
          
          # Copy build config
          cp .config "$OUTDIR/full.config"
          ./scripts/diffconfig.sh > "$OUTDIR/diffconfig" 2>/dev/null || true
          
          # Generate checksums
          (cd "$OUTDIR" && sha256sum *.bin 2>/dev/null > sha256sums.txt) || true
          
          # Get firmware info
          SYSUPGRADE=$(ls "$OUTDIR"/*-sysupgrade.bin 2>/dev/null | head -1 || echo "")
          if [ -n "$SYSUPGRADE" ]; then
            FIRMWARE_NAME=$(basename "$SYSUPGRADE")
            FIRMWARE_SIZE=$(du -h "$SYSUPGRADE" | cut -f1)
            FIRMWARE_SHA256=$(sha256sum "$SYSUPGRADE" | cut -d' ' -f1)
          else
            FIRMWARE_NAME=""
            FIRMWARE_SIZE="0"
            FIRMWARE_SHA256=""
          fi
          
          ARTIFACT_NAME="${{ env.RELEASE_PREFIX }}-${{ needs.prepare.outputs.date }}-${{ needs.prepare.outputs.short }}"
          
          # Create build info
          cat > "$OUTDIR/BUILD_INFO.json" << EOF
          {
            "device": "${{ env.DEVICE_NAME }}",
            "device_id": "${{ env.DEVICE_ID }}",
            "date": "${{ needs.prepare.outputs.date }}",
            "timestamp": "${{ needs.prepare.outputs.timestamp }}",
            "upstream_repo": "${{ env.UPSTREAM_REPO }}",
            "upstream_ref": "${{ needs.prepare.outputs.ref }}",
            "upstream_commit": "${{ needs.prepare.outputs.commit }}",
            "builder_repo": "${{ github.repository }}",
            "builder_commit": "${{ github.sha }}",
            "workflow_run": "${{ github.run_id }}",
            "firmware_name": "$FIRMWARE_NAME",
            "firmware_size": "$FIRMWARE_SIZE",
            "firmware_sha256": "$FIRMWARE_SHA256"
          }
          EOF
          
          # Markdown build info
          cat > "$OUTDIR/BUILD_INFO.md" << EOF
          # Build Information
          
          | Field | Value |
          |-------|-------|
          | Device | ${{ env.DEVICE_NAME }} |
          | Date | ${{ needs.prepare.outputs.date }} |
          | Upstream | ${{ env.UPSTREAM_REPO }}@${{ needs.prepare.outputs.short }} |
          | Firmware | $FIRMWARE_NAME |
          | Size | $FIRMWARE_SIZE |
          | SHA256 | \`${FIRMWARE_SHA256:0:16}...\` |
          | Workflow | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          EOF
          
          echo "firmware_name=$FIRMWARE_NAME" >> "$GITHUB_OUTPUT"
          echo "firmware_size=$FIRMWARE_SIZE" >> "$GITHUB_OUTPUT"
          echo "firmware_sha256=$FIRMWARE_SHA256" >> "$GITHUB_OUTPUT"
          echo "artifact_name=$ARTIFACT_NAME" >> "$GITHUB_OUTPUT"
          
          echo ""
          echo "üì¶ Artifacts collected:"
          ls -lh "$OUTDIR"
          
          # Add to step summary
          echo "## üì¶ Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "| File | Size |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          ls -lh "$OUTDIR"/*.bin 2>/dev/null | awk '{print "| " $NF " | " $5 " |"}' >> $GITHUB_STEP_SUMMARY || true

      - name: "‚òÅÔ∏è Upload firmware"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.collect.outputs.artifact_name }}
          path: openwrt/output/
          retention-days: ${{ env.ARTIFACT_RETENTION }}
          compression-level: ${{ env.COMPRESSION_LEVEL }}
          if-no-files-found: error
          overwrite: true

      - name: "‚òÅÔ∏è Upload build logs"
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ needs.prepare.outputs.date }}
          path: |
            openwrt/logs/
            openwrt/build.log
          retention-days: 7
          compression-level: 9
          if-no-files-found: ignore
          overwrite: true

      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      # TIMING & CLEANUP
      # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      - name: "‚è±Ô∏è Calculate build duration"
        id: timing
        if: always()
        run: |
          START=${{ steps.timer_start.outputs.start }}
          END=$(date +%s)
          DURATION=$((END - START))
          HOURS=$((DURATION / 3600))
          MINUTES=$(((DURATION % 3600) / 60))
          SECONDS=$((DURATION % 60))
          
          FORMATTED="${HOURS}h ${MINUTES}m ${SECONDS}s"
          echo "duration=$FORMATTED" >> "$GITHUB_OUTPUT"
          
          echo "‚è±Ô∏è Build duration: $FORMATTED"
          
          # Add to summary
          echo "## ‚è±Ô∏è Build Timing" >> $GITHUB_STEP_SUMMARY
          echo "- **Duration:** $FORMATTED" >> $GITHUB_STEP_SUMMARY

      - name: "üßπ Cleanup"
        if: always()
        run: |
          if [ -d openwrt ]; then
            cd openwrt
            # Remove large temporary files but keep caches
            rm -rf build_dir/target-*/root-* tmp/ 2>/dev/null || true
            rm -rf build_dir/target-*/linux-*/linux-*/ 2>/dev/null || true
            echo "üíæ Disk after cleanup: $(df -h . | awk 'NR==2 {print $4}')"
          fi

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 3: RELEASE - Publish to GitHub Releases with full options
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  release:
    name: üöÄ Release
    runs-on: self-hosted
    needs: [prepare, build]
    timeout-minutes: 30
    
    # Only run if should_release is true
    if: needs.prepare.outputs.should_release == 'true'
    
    # Job outputs
    outputs:
      release_url: ${{ steps.create_release.outputs.html_url }}
      release_id: ${{ steps.create_release.outputs.id }}
      upload_url: ${{ steps.create_release.outputs.upload_url }}

    steps:
      - name: "üì• Download artifacts"
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.build.outputs.artifact_name }}
          path: release/

      - name: "üìã Prepare release notes"
        id: notes
        run: |
          cat > release-notes.md << 'RELEASE_EOF'
          ## OpenWrt Firmware for ${{ env.DEVICE_NAME }}
          
          ### üì¶ Source Information
          | | |
          |---|---|
          | **Upstream** | [${{ env.UPSTREAM_REPO }}](https://github.com/${{ env.UPSTREAM_REPO }}) |
          | **Branch** | `${{ needs.prepare.outputs.ref }}` |
          | **Commit** | [`${{ needs.prepare.outputs.short }}`](https://github.com/${{ env.UPSTREAM_REPO }}/commit/${{ needs.prepare.outputs.commit }}) |
          | **Build Date** | ${{ needs.prepare.outputs.date }} |
          | **Build Time** | ${{ needs.build.outputs.build_duration }} |
          
          ### üì• Installation Guide
          | File | Description | Use Case |
          |------|-------------|----------|
          | `*-factory.bin` | Factory image | First install from stock firmware via web UI |
          | `*-sysupgrade.bin` | Sysupgrade image | Upgrade existing OpenWrt via LuCI or CLI |
          
          ### ‚ú® Included Features
          - üîê **OpenSSH** - Hardened SSH server (replaces Dropbear)
          - üîí **WireGuard** - Modern VPN protocol
          - üõ£Ô∏è **PBR** - Policy-Based Routing
          - üö´ **AdBlock Fast** - Lightweight ad blocking
          - üìä **CAKE QoS** - Smart queue management
          - üåê **LuCI** - Web interface with HTTPS support
          - üîß **Custom scripts** - Easy upgrade and configuration
          
          ### üîí Security Hardening
          - Stack protector (strong)
          - PIE executables
          - FORTIFY_SOURCE level 2
          - ASLR enabled
          - Secure SSH configuration
          
          ### ‚ö° Performance Optimizations
          - Cortex-A53 CPU tuning
          - LTO (Link-Time Optimization)
          - ccache compilation
          
          ### üìä Build Information
          | | |
          |---|---|
          | **Firmware** | `${{ needs.build.outputs.firmware_name }}` |
          | **Size** | ${{ needs.build.outputs.firmware_size }} |
          | **SHA256** | `${{ needs.build.outputs.firmware_sha256 }}` |
          | **Cache Hit** | ${{ needs.build.outputs.cache_hit }} |
          | **Workflow Run** | [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) |
          
          ---
          
          <details>
          <summary>üìã Full Changelog</summary>
          
          See [upstream commits](https://github.com/${{ env.UPSTREAM_REPO }}/commits/${{ needs.prepare.outputs.ref }}) for changes.
          
          </details>
          
          ---
          *Built automatically by [GitHub Actions](${{ github.server_url }}/${{ github.repository }}/actions) ‚Ä¢ [Report Issues](${{ github.server_url }}/${{ github.repository }}/issues)*
          RELEASE_EOF

      - name: "üöÄ Create GitHub Release"
        id: create_release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ needs.prepare.outputs.tag }}
          name: "${{ env.DEVICE_NAME }} - ${{ needs.prepare.outputs.date }}"
          bodyFile: release-notes.md
          artifacts: release/*
          artifactErrorsFailBuild: false
          makeLatest: ${{ needs.prepare.outputs.is_prerelease != 'true' && needs.prepare.outputs.is_draft != 'true' }}
          prerelease: ${{ needs.prepare.outputs.is_prerelease == 'true' }}
          draft: ${{ needs.prepare.outputs.is_draft == 'true' }}
          allowUpdates: true
          removeArtifacts: false
          replacesArtifacts: true
          generateReleaseNotes: false
          skipIfReleaseExists: false
          updateOnlyUnreleased: false
          omitBodyDuringUpdate: false
          omitNameDuringUpdate: false
          omitPrereleaseDuringUpdate: false
          omitDraftDuringUpdate: false

      - name: "üì¢ Post release summary"
        run: |
          echo "## üöÄ Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`${{ needs.prepare.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** ${{ steps.create_release.outputs.html_url }}" >> $GITHUB_STEP_SUMMARY

  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  # JOB 4: NOTIFY - Send notifications (optional)
  # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  notify:
    name: üì¢ Notify
    runs-on: self-hosted
    needs: [prepare, build, release]
    if: always() && needs.build.result != 'cancelled'
    timeout-minutes: 5

    steps:
      - name: "üìä Create workflow summary"
        run: |
          echo "# üìä Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Prepare | ${{ needs.prepare.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Release | ${{ needs.release.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.build.result }}" = "success" ]; then
            echo "## üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
            echo "- **Firmware:** \`${{ needs.build.outputs.firmware_name }}\`" >> $GITHUB_STEP_SUMMARY
            echo "- **Size:** ${{ needs.build.outputs.firmware_size }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Duration:** ${{ needs.build.outputs.build_duration }}" >> $GITHUB_STEP_SUMMARY
          fi

      - name: "‚úÖ Success notification"
        if: needs.build.result == 'success'
        run: |
          echo "‚úÖ Build completed successfully!"
          echo "üì¶ Artifact: ${{ needs.build.outputs.artifact_name }}"

      - name: "‚ùå Failure notification"
        if: needs.build.result == 'failure'
        run: |
          echo "::error::Build failed! Check the logs for details."
          echo "‚ùå Build failed for ${{ env.DEVICE_NAME }}"
