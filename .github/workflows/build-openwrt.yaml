name: Build OpenWrt Targets

permissions:
  contents: write
  actions: read

on:
  push:
    branches:
      - main
    paths:
      - "*.config"
      - "files/**"
      - ".github/workflows/build-openwrt.yaml"
  workflow_dispatch:
    inputs:
      target:
        description: "Which target to build"
        required: false
        default: all
        type: choice
        options:
          - all
          - wr3000
      remote_ref:
        description: "Override upstream ref (optional)"
        required: false
        default: ""
  schedule:
    - cron: "38 1 * * *"

concurrency:
  group: openwrt-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  BUILDER_REPO: ${{ github.repository }}
  DL_CACHE_VERSION: v1
  ARTIFACT_RETENTION_DAYS: 10
  GH_TOKEN: ${{ github.token }}

jobs:
  build:
    name: Build Cudy WR3000-v1
    runs-on: self-hosted
    env:
      CONFIG_FILE: wr3000.config
      REMOTE_REPOSITORY: openwrt/openwrt
      REMOTE_REF: main
      RELEASE_PREFIX: wr3000
      ARTIFACT_PREFIX: wr3000

    steps:
      - name: Cleanup workspace
        run: |
          echo "=== Workspace Cleanup ==="
          echo "Current directory: $PWD"
          echo "Disk space before cleanup:"
          df -h . | tail -1
          
          # Remove old build artifacts but preserve caches
          rm -rf openwrt builder 2>/dev/null || true
          
          # Clean up any leftover lock files
          find . -name '*.lock' -delete 2>/dev/null || true
          
          echo "Disk space after cleanup:"
          df -h . | tail -1

      - name: Checkout builder repository
        uses: actions/checkout@v4
        with:
          path: builder

      - name: Verify build dependencies
        run: |
          echo "Checking build dependencies..."
          missing=()
          for cmd in git gcc g++ make gawk wget unzip python3 rsync flex bison swig; do
            command -v $cmd >/dev/null || missing+=("$cmd")
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing dependencies: ${missing[*]}"
            if command -v apt >/dev/null 2>&1; then
              sudo apt update -qq
              sudo apt install -y build-essential clang flex bison g++ gawk gettext libncurses-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget llvm
            else
              echo "::error::Missing dependencies and apt not available. Install manually."
              exit 1
            fi
          else
            echo "All required dependencies present"
          fi

      - name: Fetch upstream OpenWrt source
        id: upstream
        run: |
          set -euo pipefail
          
          # Clean up any existing openwrt directory from previous runs
          if [ -d "openwrt" ]; then
            echo "Removing existing openwrt directory..."
            rm -rf openwrt
          fi
          
          REF="${{ env.REMOTE_REF }}"
          if [ "$REF" = "auto-next" ]; then
            REF=$(git ls-remote https://github.com/${{ env.REMOTE_REPOSITORY }}.git "refs/heads/next-*" \
              | grep -vi 'test' \
              | awk '{print $2}' \
              | sed 's|refs/heads/||' \
              | sort -V \
              | tail -n1)
          fi
          if [ -n "${{ github.event.inputs.remote_ref }}" ]; then
            REF="${{ github.event.inputs.remote_ref }}"
          fi
          if [ -z "$REF" ]; then
            echo "Unable to determine upstream ref" >&2
            exit 1
          fi
          echo "Cloning OpenWrt from ${{ env.REMOTE_REPOSITORY }} (ref: $REF)"
          git clone --depth=1 --filter=blob:none --single-branch --branch "$REF" https://github.com/${{ env.REMOTE_REPOSITORY }}.git openwrt
          cd openwrt
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Cache feeds
        uses: actions/cache@v4
        with:
          path: |
            openwrt/feeds
            openwrt/.feeds_updated
          key: feeds-${{ hashFiles('openwrt/feeds.conf.default') }}-${{ github.sha }}
          restore-keys: |
            feeds-${{ hashFiles('openwrt/feeds.conf.default') }}-
            feeds-

      - name: Update and install feeds
        run: |
          cd openwrt
          
          # Configure git for better reliability
          git config --global http.postBuffer 1048576000
          git config --global http.lowSpeedLimit 1000
          git config --global http.lowSpeedTime 300
          git config --global core.compression 0
          git config --global protocol.version 2
          
          # Check if feeds are already current
          if [ -f .feeds_updated ]; then
            echo "Using cached feeds, doing quick update..."
            ./scripts/feeds update -a || {
              echo "Cached feeds update failed, forcing fresh clone..."
              rm -rf feeds .feeds_updated
            }
          fi
          
          # Update feeds with robust retry logic
          if [ ! -f .feeds_updated ]; then
            for i in {1..5}; do
              echo "Attempt $i/5: Updating feeds..."
              if timeout 600 ./scripts/feeds update -a; then
                echo "Feeds updated successfully"
                touch .feeds_updated
                break
              else
                echo "Feed update failed (exit code: $?)"
                if [ $i -lt 5 ]; then
                  echo "Retrying in 15 seconds..."
                  sleep 15
                  # Clean up partial clones
                  find feeds -name '*.git/index.lock' -delete 2>/dev/null || true
                else
                  echo "::error::Failed to update feeds after 5 attempts"
                  exit 1
                fi
              fi
            done
          fi
          
          # Install feeds with retries
          for i in {1..2}; do
            ./scripts/feeds install -a || {
              if [ $i -eq 1 ]; then
                echo "First feed install attempt failed, retrying..."
                sleep 5
              else
                echo "::error::Feed installation failed"
                exit 1
              fi
            }
          done

      - name: Restore downloads cache
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: openwrt-dl-wr3000-${{ env.DL_CACHE_VERSION }}-${{ hashFiles('builder/wr3000.config') }}
          restore-keys: |
            openwrt-dl-wr3000-${{ env.DL_CACHE_VERSION }}-

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-wr3000-${{ github.sha }}
          restore-keys: |
            ccache-wr3000-

      - name: Cache toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: toolchain-wr3000-${{ hashFiles('builder/wr3000.config') }}
          restore-keys: |
            toolchain-wr3000-

      - name: Prepare configuration and overlay
        run: |
          cd openwrt
          mkdir -p files
          cp -a ../builder/files/. ./files/
          if [ -f ./files/usr/bin/upgrade_custom_openwrt ]; then
            sed -i "s|XXXXXX/XXXXXX|${{ github.repository }}|" ./files/usr/bin/upgrade_custom_openwrt || true
            chmod 755 ./files/usr/bin/upgrade_custom_openwrt
          fi
          cp ../builder/${{ env.CONFIG_FILE }} .config
          echo "CONFIG_CCACHE=y" >> .config
          make defconfig

      - name: Download sources
        run: |
          cd openwrt
          CORES=$(nproc)
          DOWNLOAD_JOBS=$((CORES * 2))
          echo "Downloading with $DOWNLOAD_JOBS parallel jobs ($(nproc) cores available)"
          
          # First attempt with parallel downloads
          if ! make download -j${DOWNLOAD_JOBS} V=s; then
            echo "Parallel download failed, retrying with reduced parallelism..."
            sleep 5
            
            # Second attempt with fewer jobs
            if ! make download -j${CORES} V=s; then
              echo "Reduced parallel download failed, trying sequential..."
              sleep 10
              
              # Final attempt sequentially
              if ! make download -j1 V=sc; then
                echo "::error::All download attempts failed"
                echo "Attempting to identify missing packages..."
                make download -j1 V=s 2>&1 | grep -E '(ERROR|Download failed)' || true
                exit 1
              fi
            fi
          fi
          
          echo "All sources downloaded successfully"
          du -sh dl/ || true

      - name: Build firmware
        env:
          CCACHE_DIR: ${{ github.workspace }}/../.ccache
          FORCE_UNSAFE_CONFIGURE: 1
        run: |
          cd openwrt
          
          # Pre-build checks
          echo "=== Pre-build System Status ==="
          echo "Available disk space:"
          df -h . | tail -1
          echo "Memory status:"
          free -h || true
          echo "CPU cores: $(nproc)"
          
          # Check for minimum disk space (15GB)
          AVAILABLE_KB=$(df --output=avail . | tail -1)
          if [ "$AVAILABLE_KB" -lt 15728640 ]; then
            echo "::warning::Low disk space: $(($AVAILABLE_KB / 1024 / 1024))GB available"
          fi
          
          CORES=$(nproc)
          BUILD_JOBS=$((CORES + 1))
          
          echo "=== Starting Build ==="
          echo "Build jobs: $BUILD_JOBS"
          echo "CCACHE enabled at: $CCACHE_DIR"
          
          # Parallel build with monitoring
          if ! make -j${BUILD_JOBS} V=w; then
            echo "::warning::Parallel build failed, analyzing error..."
            
            # Check disk space
            df -h . | tail -1
            
            # Clean build_dir to free space
            echo "Cleaning temporary build files..."
            rm -rf build_dir/target-*/root-* build_dir/target-*/linux-*/tmp/ 2>/dev/null || true
            
            # Retry with fewer jobs
            echo "Retrying with $CORES jobs..."
            if ! make -j${CORES} V=w; then
              echo "::error::Reduced parallel build failed, trying single-threaded verbose build"
              
              # Final attempt with full verbosity for debugging
              if ! make -j1 V=sc; then
                echo "::error::Build failed completely"
                echo "=== Last 100 lines of build output ==="
                tail -100 logs/* 2>/dev/null || true
                exit 1
              fi
            fi
          fi
          
          echo "=== Build Complete ==="
          echo "Final disk usage:"
          df -h . | tail -1
          echo "Build artifacts:"
          du -sh bin/ 2>/dev/null || true

      - name: Collect firmware artifacts
        run: |
          cd openwrt
          ART_DIR="artifacts/wr3000"
          mkdir -p "$ART_DIR"
          
          echo "=== Collecting Build Artifacts ==="
          
          # Copy configuration
          cp .config "$ART_DIR/full.config"
          
          # Find and copy firmware files
          FIRMWARE_COUNT=0
          while IFS= read -r -d '' file; do
            cp "$file" "$ART_DIR/"
            FIRMWARE_COUNT=$((FIRMWARE_COUNT + 1))
          done < <(find bin -type f \( -name 'openwrt-*-sysupgrade.bin' -o -name 'openwrt-*-factory.bin' -o -name 'config.buildinfo' -o -name 'sha256sums' \) -print0)
          
          if [ $FIRMWARE_COUNT -eq 0 ]; then
            echo "::error::No firmware files found in bin/ directory"
            echo "Checking bin/ structure:"
            find bin -type f -name '*.bin' || true
            exit 1
          fi
          
          # Generate checksums
          if ls "$ART_DIR"/openwrt-*.bin >/dev/null 2>&1; then
            (cd "$ART_DIR" && sha256sum openwrt-*.bin > sha256sums.txt)
            echo "âœ“ Checksums generated"
          fi
          
          # Create build summary
          cat > \"$ART_DIR/build-info.txt\" <<'EOF'
          === Build Information ===
          EOF
          echo \"Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')\" >> \"$ART_DIR/build-info.txt\"
          echo \"Repository: ${{ github.repository }}\" >> \"$ART_DIR/build-info.txt\"
          echo \"Commit: ${{ github.sha }}\" >> \"$ART_DIR/build-info.txt\"
          echo \"Workflow: ${{ github.workflow }}\" >> \"$ART_DIR/build-info.txt\"
          echo \"Runner: $(uname -n)\" >> \"$ART_DIR/build-info.txt\"
          echo \"\" >> \"$ART_DIR/build-info.txt\"
          echo \"=== Firmware Files ===\" >> \"$ART_DIR/build-info.txt\"
          ls -lh \"$ART_DIR\"/*.bin >> \"$ART_DIR/build-info.txt\" 2>/dev/null || true
          
          echo "=== Artifacts Summary ==="
          cat "$ART_DIR/build-info.txt"
          echo ""
          echo "All artifacts:"
          ls -lh "$ART_DIR"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.ARTIFACT_PREFIX }}-firmware
          path: openwrt/artifacts/wr3000
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Prepare release notes
        id: meta
        run: |
          tag="${{ env.RELEASE_PREFIX }}-$(date +%Y%m%d-%H%M)"
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
          echo "release_name=Cudy WR3000-v1 firmware ($tag)" >> "$GITHUB_OUTPUT"
          cat <<'EOF' > release-notes-wr3000.md
          ### Target
          - Name: Cudy WR3000-v1
          - Config: `wr3000.config`

          ### Upstream
          - Repository: https://github.com/${{ env.REMOTE_REPOSITORY }}
          - Ref: ${{ steps.upstream.outputs.ref }}
          - Commit: ${{ steps.upstream.outputs.commit }}

          ### Notes
          - Artifacts contain sysupgrade images, buildinfo, and `.config`
          - Built from https://github.com/${{ github.repository }}
          EOF

      - name: Publish release
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: ${{ steps.meta.outputs.release_tag }}
          name: ${{ steps.meta.outputs.release_name }}
          bodyFile: release-notes-wr3000.md
          artifacts: openwrt/artifacts/wr3000/*
          replacesArtifacts: true
          makeLatest: false

      - name: Cleanup build directory
        if: always()
        run: |
          echo "=== Cleaning up build artifacts ==="
          
          if [ -d openwrt ]; then
            cd openwrt
            
            echo "Disk usage before cleanup:"
            df -h . | tail -1
            
            # Remove temporary build files but keep useful caches
            echo "Removing temporary build artifacts..."
            rm -rf build_dir/target-*/root-* 2>/dev/null || true
            rm -rf build_dir/target-*/linux-*/tmp/ 2>/dev/null || true
            rm -rf tmp/ 2>/dev/null || true
            rm -rf logs/ 2>/dev/null || true
            
            # Clean staging except toolchain (already cached separately)
            find staging_dir -mindepth 1 -maxdepth 1 ! -name 'toolchain-*' -exec rm -rf {} + 2>/dev/null || true
            
            # Clean old package build dirs but keep dl/ cache
            find build_dir/target-*/*/build_dir/ -type d -name 'ipkg-*' -exec rm -rf {} + 2>/dev/null || true
            
            echo "Disk usage after cleanup:"
            df -h . | tail -1
            
            echo "Cleanup complete"
          else
            echo "OpenWrt directory not found, skipping cleanup"
          fi
