name: Build OpenWrt Targets

permissions:
  contents: write
  actions: read

on:
  push:
    branches:
      - main
    paths:
      - "*.config"
      - "files/**"
      - ".github/workflows/build-openwrt.yaml"
  workflow_dispatch:
    inputs:
      target:
        description: "Which target to build"
        required: false
        default: all
        type: choice
        options:
          - all
          - wr3000
      remote_ref:
        description: "Override upstream ref (optional)"
        required: false
        default: ""
  schedule:
    - cron: "38 1 * * *"

concurrency:
  group: openwrt-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

env:
  BUILDER_REPO: ${{ github.repository }}
  DL_CACHE_VERSION: v1
  ARTIFACT_RETENTION_DAYS: 10
  GH_TOKEN: ${{ github.token }}

jobs:
  build:
    name: Build ${{ matrix.pretty }}
    runs-on: ${{ fromJson(matrix.runner) }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - id: wr3000
            pretty: Cudy WR3000-v1
            config_file: wr3000.config
            remote_repository: openwrt/openwrt
            remote_ref: main
            release_prefix: wr3000
            artifact_prefix: wr3000
            runner: '["self-hosted","linux","x64","debian"]'

    steps:
      - name: Checkout builder repository
        uses: actions/checkout@v4
        with:
          path: builder

      - name: Verify build dependencies
        run: |
          echo "Checking build dependencies..."
          missing=()
          for cmd in git gcc g++ make gawk wget unzip python3 rsync flex bison swig; do
            command -v $cmd >/dev/null || missing+=("$cmd")
          done
          if [ ${#missing[@]} -gt 0 ]; then
            echo "Missing dependencies: ${missing[*]}"
            if command -v apt >/dev/null 2>&1; then
              sudo apt update -qq
              sudo apt install -y build-essential clang flex bison g++ gawk gettext libncurses-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget llvm
            else
              echo "::error::Missing dependencies and apt not available. Install manually."
              exit 1
            fi
          else
            echo "All required dependencies present"
          fi

      - name: Fetch upstream OpenWrt source
        id: upstream
        run: |
          set -euo pipefail
          REF="${{ matrix.remote_ref }}"
          if [ "$REF" = "auto-next" ]; then
            REF=$(git ls-remote https://github.com/${{ matrix.remote_repository }}.git "refs/heads/next-*" \
              | grep -vi 'test' \
              | awk '{print $2}' \
              | sed 's|refs/heads/||' \
              | sort -V \
              | tail -n1)
          fi
          if [ -n "${{ github.event.inputs.remote_ref }}" ]; then
            REF="${{ github.event.inputs.remote_ref }}"
          fi
          if [ -z "$REF" ]; then
            echo "Unable to determine upstream ref" >&2
            exit 1
          fi
          echo "Cloning OpenWrt from ${{ matrix.remote_repository }} (ref: $REF)"
          git clone --depth=1 --filter=blob:none --single-branch --branch "$REF" https://github.com/${{ matrix.remote_repository }}.git openwrt
          cd openwrt
          echo "ref=$REF" >> "$GITHUB_OUTPUT"
          echo "commit=$(git rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "short=$(git rev-parse --short HEAD)" >> "$GITHUB_OUTPUT"

      - name: Update and install feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a
          ./scripts/feeds install -a
          ./scripts/feeds install -a

      - name: Restore downloads cache
        uses: actions/cache@v4
        with:
          path: openwrt/dl
          key: openwrt-dl-${{ matrix.id }}-${{ env.DL_CACHE_VERSION }}-${{ hashFiles(format('builder/{0}', matrix.config_file)) }}
          restore-keys: |
            openwrt-dl-${{ matrix.id }}-${{ env.DL_CACHE_VERSION }}-

      - name: Setup ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ccache-${{ matrix.id }}-${{ github.sha }}
          restore-keys: |
            ccache-${{ matrix.id }}-

      - name: Cache toolchain
        uses: actions/cache@v4
        with:
          path: |
            openwrt/staging_dir/toolchain-*
            openwrt/build_dir/toolchain-*
          key: toolchain-${{ matrix.id }}-${{ hashFiles(format('builder/{0}', matrix.config_file)) }}
          restore-keys: |
            toolchain-${{ matrix.id }}-

      - name: Prepare configuration and overlay
        run: |
          cd openwrt
          mkdir -p files
          cp -a ../builder/files/. ./files/
          if [ -f ./files/usr/bin/upgrade_custom_openwrt ]; then
            sed -i "s|XXXXXX/XXXXXX|${{ github.repository }}|" ./files/usr/bin/upgrade_custom_openwrt || true
            chmod 755 ./files/usr/bin/upgrade_custom_openwrt
          fi
          cp ../builder/${{ matrix.config_file }} .config
          echo "CONFIG_CCACHE=y" >> .config
          make defconfig

      - name: Download sources
        run: |
          cd openwrt
          echo "Downloading with $(nproc) parallel jobs"
          make download -j$(nproc) V=s || make download -j1 V=s

      - name: Build firmware
        env:
          CCACHE_DIR: ${{ github.workspace }}/../.ccache
        run: |
          cd openwrt
          echo "Building with $(nproc) parallel jobs (ccache enabled)"
          make -j$(($(nproc) + 1)) || {
            echo "Build failed, retrying with verbose single-thread build"
            make -j1 V=s
          }

      - name: Collect firmware artifacts
        run: |
          cd openwrt
          ART_DIR="artifacts/${{ matrix.id }}"
          mkdir -p "$ART_DIR"
          cp .config "$ART_DIR/full.config"
          find bin -type f \( -name 'openwrt-*-sysupgrade.bin' -o -name 'openwrt-*-factory.bin' -o -name 'config.buildinfo' -o -name 'sha256sums' \) -exec cp {} "$ART_DIR" \; || true
          if ls "$ART_DIR"/openwrt-*.bin >/dev/null 2>&1; then
            (cd "$ART_DIR" && sha256sum openwrt-*.bin > sha256sums.txt)
          fi
          echo "Build artifacts collected:"
          ls -lh "$ART_DIR"

      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_prefix }}-firmware
          path: openwrt/artifacts/${{ matrix.id }}
          retention-days: ${{ env.ARTIFACT_RETENTION_DAYS }}

      - name: Prepare release notes
        id: meta
        run: |
          tag="${{ matrix.release_prefix }}-$(date +%Y%m%d-%H%M)"
          echo "release_tag=$tag" >> "$GITHUB_OUTPUT"
          echo "release_name=${{ matrix.pretty }} firmware ($tag)" >> "$GITHUB_OUTPUT"
          cat <<'EOF' > release-notes-${{ matrix.id }}.md
          ### Target
          - Name: ${{ matrix.pretty }}
          - Config: `${{ matrix.config_file }}`

          ### Upstream
          - Repository: https://github.com/${{ matrix.remote_repository }}
          - Ref: ${{ steps.upstream.outputs.ref }}
          - Commit: ${{ steps.upstream.outputs.commit }}

          ### Notes
          - Artifacts contain sysupgrade images, buildinfo, and `.config`
          - Built from https://github.com/${{ github.repository }}
          EOF

      - name: Publish release
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: ${{ steps.meta.outputs.release_tag }}
          name: ${{ steps.meta.outputs.release_name }}
          bodyFile: release-notes-${{ matrix.id }}.md
          artifacts: openwrt/artifacts/${{ matrix.id }}/*
          replacesArtifacts: true
          makeLatest: false

      - name: Cleanup build directory
        if: always()
        run: |
          echo "Cleaning up build artifacts to save disk space"
          cd openwrt || exit 0
          rm -rf build_dir/target-* tmp/ || true
          echo "Cleanup complete"
